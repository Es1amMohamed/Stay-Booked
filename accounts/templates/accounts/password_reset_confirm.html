{% extends "base_generic.html" %}
{% load bootstrap4 %}

{% block h2 %}  
<h2>Reset Password</h2>        
{% endblock h2 %}

{% block contant %}

<form id="resetPasswordForm">
  {% csrf_token %}
  <input type="password" id="newPassword" placeholder="New Password"
         class="form-control mb-3" required>

  <input type="password" id="confirmPassword" placeholder="Confirm New Password"
         class="form-control mb-3" required>

  <button type="submit" class="btn palatin-btn mt-50">Reset Password</button>
</form>

<div id="message" class="alert mt-3 d-none"></div>

<script>
  document.getElementById("resetPasswordForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    let newPassword = document.getElementById("newPassword").value;
    let confirmPassword = document.getElementById("confirmPassword").value;
    let messageDiv = document.getElementById("message");

    if (newPassword !== confirmPassword) {
      messageDiv.textContent = "Passwords do not match!";
      messageDiv.className = "alert alert-danger mt-3";
      messageDiv.classList.remove("d-none");
      return;
    }

    // استخرج uidb64 و token من ال URL
    let pathParts = window.location.pathname.split("/");
    let uidb64 = pathParts[pathParts.length - 3]; 
    let token = pathParts[pathParts.length - 2];

    try {
      let response = await fetch(`/accounts/password/reset/confirm/${uidb64}/${token}/`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({
          new_password: newPassword
        })
      });

      let result = await response.json();

      if (response.ok) {
        messageDiv.textContent = result.message || "Password has been reset successfully!";
        messageDiv.className = "alert alert-success mt-3";
        messageDiv.classList.remove("d-none");
        setTimeout(() => {
          window.location.href = "/accounts/login/";
        }, 2000);
      } else {
        messageDiv.textContent = result.error || "Something went wrong, try again!";
        messageDiv.className = "alert alert-danger mt-3";
        messageDiv.classList.remove("d-none");
      }
    } catch (err) {
      messageDiv.textContent = "Error: " + err.message;
      messageDiv.className = "alert alert-danger mt-3";
      messageDiv.classList.remove("d-none");
    }
  });
</script>

{% endblock contant %}
