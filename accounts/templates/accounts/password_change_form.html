{% extends "base_generic.html" %}
{% load bootstrap4 %}

{% block h2 %}  
<h2>Change Password</h2>        
{% endblock h2 %}

{% block contant %}
  <form id="changePasswordForm">
    {% csrf_token %}
    <input type="password" id="oldPassword" placeholder="Old Password" class="form-control mb-2" required>
    <input type="password" id="newPassword" placeholder="New Password" class="form-control mb-2" required>
    <input type="submit" class="btn palatin-btn mt-50" value="Change password">
  </form>

  <p id="msg" class="mt-3"></p>

<script>
  document.getElementById("changePasswordForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const oldPassword = document.getElementById("oldPassword").value;
    const newPassword = document.getElementById("newPassword").value;

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    try {
      const response = await fetch("{% url 'accounts:change-password' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrftoken,
          "Authorization": "Bearer " + localStorage.getItem("access")
        },
        body: JSON.stringify({
          old_password: oldPassword,
          new_password: newPassword
        })
      });

      const text = await response.text();  
      console.log("Raw response:", text);

      const msg = document.getElementById("msg");

      let data;
      try {
        data = JSON.parse(text); 
      } catch {
        data = {error: text};
      }

      if (response.ok) {
        msg.innerText = data.success || "Password changed successfully";
        msg.style.color = "green";
      } else {
        msg.innerText = data.error || JSON.stringify(data);
        msg.style.color = "red";
      }

    } catch (err) {
      console.error("Error:", err);
    }
  });
</script>

{% endblock contant %}
